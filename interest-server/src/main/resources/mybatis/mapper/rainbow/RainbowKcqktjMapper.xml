<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.interest.dao.rainbow.RainbowKcqktjDao">

	<!-- 库存概览, 添加分页 -->
	<select id="jkppsgk" resultType="java.util.HashMap" >
		select date(a.created_at) 日期,sum(b.lottery_count) 即开票数量（张）,sum(b.lottery_count*d.COUP_Money) 总价值（元）,count(distinct(a.package_no)) 总包裹数
		from t_storage_checkout_packages a left join  t_storage_checkout_packages_detail b
		ON a.package_no = b.package_no
		LEFT JOIN t_customer_coupon_sub_info c
		ON left(b.lottery_start_id,5) = c.COUPS_Prefix
		LEFT JOIN t_customer_coupon_info d
		ON d.COUP_Uid = c.COUPS_CPUid
		left join study.t_device_sub_info e
		on a.device_no = e.DDI_No
		left join netfiance_db.t_shop_shop_info f
		on e.SHOP_No = f.SHOP_No
		left join t_device_device_info g
		on a.device_no = g.DDI_No
		left join netfiance_db.t_shop_agent_list e
		on f.SHOP_AGUid = e.AGNT_Uid
		left join netfiance_db.t_shop_agent_top h
		on e.AGNT_ATUid = h.ATOP_Uid
		left join study.t_shop_sub_info j
		on f.SHOP_No = j.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = f.SHOP_Class
		where date(a.created_at) >= #{startDate} and date(a.created_at) &lt;= #{endDate}
		and a.created_at >= e.DSI_Try and (a.created_at &lt;= e.DSI_Withdraw or e.DSI_Withdraw is null)
		and DSI_Anti is null
		#and h.ATOP_Title = {{选择渠道}}
		#and g.DDI_Type = {{选择设备类型}}
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		group by 日期


		limit #{pageWrapper.start},#{pageWrapper.pageSize};
	</select>

	<!-- 库存概览，在最外层加了个select count *  -->
	<select id="jkppsgk_count" resultType="Integer">
		select count(*) from
		(
		select date(a.created_at) 日期,sum(b.lottery_count) 即开票数量（张）,sum(b.lottery_count*d.COUP_Money) 总价值（元）,count(distinct(a.package_no)) 总包裹数
		from t_storage_checkout_packages a left join  t_storage_checkout_packages_detail b
		ON a.package_no = b.package_no
		LEFT JOIN t_customer_coupon_sub_info c
		ON left(b.lottery_start_id,5) = c.COUPS_Prefix
		LEFT JOIN t_customer_coupon_info d
		ON d.COUP_Uid = c.COUPS_CPUid
		left join study.t_device_sub_info e
		on a.device_no = e.DDI_No
		left join netfiance_db.t_shop_shop_info f
		on e.SHOP_No = f.SHOP_No
		left join t_device_device_info g
		on a.device_no = g.DDI_No
		left join netfiance_db.t_shop_agent_list e
		on f.SHOP_AGUid = e.AGNT_Uid
		left join netfiance_db.t_shop_agent_top h
		on e.AGNT_ATUid = h.ATOP_Uid
		left join study.t_shop_sub_info j
		on f.SHOP_No = j.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = f.SHOP_Class
		where date(a.created_at) >= #{startDate} and date(a.created_at) &lt;= #{endDate}
		and a.created_at >= e.DSI_Try and (a.created_at &lt;= e.DSI_Withdraw or e.DSI_Withdraw is null)
		and DSI_Anti is null
		#and h.ATOP_Title = {{选择渠道}}
		#and g.DDI_Type = {{选择设备类型}}
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		group by 日期
		) temp
	</select>

	<!-- 库存明细, 添加分页 -->
	<select id="jkppsmx" resultType="java.util.HashMap" >
		select date(a.created_at) 日期,a.device_no 设备编号,f.SHOP_No 网点编号,f.SHOP_Title 网点名称,d.COUP_Title 票种,d.COUP_Money 面值,sum(b.lottery_count) 即开票数量（张）,sum(b.lottery_count*d.COUP_Money) 总价值（元）,a.created_at 出库时间,a.updated_at 加仓时间,m.USER_Nickname 配送员昵称,f.SHOP_Address 门店地址
		from t_storage_checkout_packages a left join  t_storage_checkout_packages_detail b
		ON a.package_no = b.package_no
		LEFT JOIN t_customer_coupon_sub_info c
		ON left(b.lottery_start_id,5) = c.COUPS_Prefix
		LEFT JOIN t_customer_coupon_info d
		ON d.COUP_Uid = c.COUPS_CPUid
		left join t_customer_user_info m
		on a.delivery_id = m.USER_Uid
		left join study.t_device_sub_info e
		on a.device_no = e.DDI_No
		left join netfiance_db.t_shop_shop_info f
		on e.SHOP_No = f.SHOP_No
		left join t_device_device_info g
		on a.device_no = g.DDI_No
		left join netfiance_db.t_shop_agent_list e
		on f.SHOP_AGUid = e.AGNT_Uid
		left join netfiance_db.t_shop_agent_top h
		on e.AGNT_ATUid = h.ATOP_Uid
		left join study.t_shop_sub_info j
		on f.SHOP_No = j.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = f.SHOP_Class
		where date(a.created_at) >= #{startDate} and date(a.created_at) &lt;= #{endDate}
		and a.created_at >= e.DSI_Try and (a.created_at &lt;= e.DSI_Withdraw or e.DSI_Withdraw is null)
		and DSI_Anti is null
		#and h.ATOP_Title = {{选择渠道}}
		#and g.DDI_Type = {{选择设备类型}}
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		group by 日期,设备编号,网点编号,票种,出库时间,加仓时间,配送员昵称

		limit #{pageWrapper.start},#{pageWrapper.pageSize};
	</select>

	<!-- 库存明细，在最外层加了个select count *  -->
	<select id="jkppsmx_count" resultType="Integer">
		select count(*) from
		(
		select date(a.created_at) 日期,a.device_no 设备编号,f.SHOP_No 网点编号,f.SHOP_Title 网点名称,d.COUP_Title 票种,d.COUP_Money 面值,sum(b.lottery_count) 即开票数量（张数）,sum(b.lottery_count*d.COUP_Money) 总价值（元）,a.created_at 出库时间,a.updated_at 加仓时间,m.USER_Nickname 配送员昵称,f.SHOP_Address 门店地址
		from t_storage_checkout_packages a left join  t_storage_checkout_packages_detail b
		ON a.package_no = b.package_no
		LEFT JOIN t_customer_coupon_sub_info c
		ON left(b.lottery_start_id,5) = c.COUPS_Prefix
		LEFT JOIN t_customer_coupon_info d
		ON d.COUP_Uid = c.COUPS_CPUid
		left join t_customer_user_info m
		on a.delivery_id = m.USER_Uid
		left join study.t_device_sub_info e
		on a.device_no = e.DDI_No
		left join netfiance_db.t_shop_shop_info f
		on e.SHOP_No = f.SHOP_No
		left join t_device_device_info g
		on a.device_no = g.DDI_No
		left join netfiance_db.t_shop_agent_list e
		on f.SHOP_AGUid = e.AGNT_Uid
		left join netfiance_db.t_shop_agent_top h
		on e.AGNT_ATUid = h.ATOP_Uid
		left join study.t_shop_sub_info j
		on f.SHOP_No = j.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = f.SHOP_Class
		where date(a.created_at) >= #{startDate} and date(a.created_at) &lt;= #{endDate}
		and a.created_at >= e.DSI_Try and (a.created_at &lt;= e.DSI_Withdraw or e.DSI_Withdraw is null)
		and DSI_Anti is null
		#and h.ATOP_Title = {{选择渠道}}
		#and g.DDI_Type = {{选择设备类型}}
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		group by 日期,设备编号,网点编号,票种,出库时间,加仓时间,配送员昵称
		) temp
	</select>

	<!-- 出库包裹数 -->
	<select id="ckbgs" resultType="java.util.HashMap" >
		select c.DDI_Type 设备类型,count(distinct(a.package_no)) 出库包裹数
		from t_storage_checkout_packages a left join study.t_device_sub_info b
		on b.DDI_No = a.device_no
		left join t_device_device_info c
		on b.DDI_No = c.DDI_No
		left join netfiance_db.t_shop_shop_info e
		on b.SHOP_No = e.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON e.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join study.t_shop_sub_info d
		on e.SHOP_No = d.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) l
		on l.DICT_Value = e.SHOP_Class
		where DSI_Anti is null
		and a.created_at >= b.SHOP_No and (a.created_at &lt;= b.DSI_Withdraw or b.DSI_Withdraw is null)
		and date(a.created_at)>=#{startDate} and date(a.created_at) &lt;= #{endDate}

		#and g.ATOP_Title = {{选择渠道}}
		#and c.DDI_Type = {{选择设备类型}}
		#and d.SHOP_Area = '{{ 所属地区 }}'
		#and l.DICT_Name = '{{ 网点类型 }}'

		group by DDI_Type
	</select>

	<!-- 在途包裹数 -->
	<select id="ztbgs" resultType="java.util.HashMap" >
		select c.DDI_Type 设备类型,count(distinct(a.package_no)) 在途包裹数
		from t_storage_checkout_packages a left join study.t_device_sub_info b
		on b.DDI_No = a.device_no
		left join t_device_device_info c
		on b.DDI_No = c.DDI_No
		left join netfiance_db.t_shop_shop_info e
		on b.SHOP_No = e.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON e.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join study.t_shop_sub_info d
		on e.SHOP_No = d.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) l
		on l.DICT_Value = e.SHOP_Class
		where DSI_Anti is null
		and a.created_at >= b.SHOP_No and (a.created_at &lt;= b.DSI_Withdraw or b.DSI_Withdraw is null)
		and a.created_at &lt;= #{queryDate} and (a.updated_at >= #{queryDate} or a.updated_at = a.created_at)

		#and g.ATOP_Title = {{选择渠道}}
		#and c.DDI_Type = {{选择设备类型}}
		#and d.SHOP_Area = '{{ 所属地区 }}'
		#and l.DICT_Name = '{{ 网点类型 }}'


		group by DDI_Type

	</select>





</mapper>
