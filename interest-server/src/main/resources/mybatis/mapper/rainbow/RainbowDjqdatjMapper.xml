<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.interest.dao.rainbow.RainbowDjqdatjDao">

	<!-- 机器属性信息，添加分页 -->
	<select id="jqsxxx_list" resultType="java.util.HashMap">
		select a.DDI_No 机器编号,a.SHOP_No 网点编号, DATE_FORMAT(a.DSI_Try, '%Y-%m-%d') 启用时间,c.SHOP_Address 设备位置,b.DDI_Type 设备类型
		from study.t_device_sub_info a left join t_device_device_info b
		on a.DDI_No = b.DDI_No
		left join netfiance_db.t_shop_shop_info c
		on a.SHOP_No = c.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON c.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join study.t_shop_sub_info d
		on c.SHOP_Uid = d.SHOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = c.SHOP_Class
		where date(a.DSI_Try) >= #{startDate} and date(a.DSI_Try) &lt;= #{endDate}
		#and a.DDI_No = '{{设备编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and b.DDI_Type = '{{ 设备类型 }}'
		#and a.SHOP_No = '{{ 网点编号 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and d.SHOP_Area = '{{ 所属地区 }}'

		limit #{pageWrapper.start},#{pageWrapper.pageSize};
	</select>

	<!-- 有改动，添加count -->
	<select id="jqsxxx_list_count" parameterType="String" resultType = "Integer">
		select count(a.DDI_No)
		from study.t_device_sub_info a left join t_device_device_info b
		on a.DDI_No = b.DDI_No
		left join netfiance_db.t_shop_shop_info c
		on a.SHOP_No = c.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON c.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join study.t_shop_sub_info d
		on c.SHOP_Uid = d.SHOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = c.SHOP_Class

		where date(a.DSI_Try) >= #{startDate} and date(a.DSI_Try) &lt;= #{endDate}
		#and a.DDI_No = '{{设备编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and b.DDI_Type = '{{ 设备类型 }}'
		#and a.SHOP_No = '{{ 网点编号 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and d.SHOP_Area = '{{ 所属地区 }}'
	</select>

	<!-- 添加where查询条件。添加LIMIT 1控制只能显示一条数据 -->
	<select id="jqsxxx" parameterType="String" resultType = "java.util.HashMap">
		select a.DDI_No 机器编号,a.SHOP_No 网点编号,DATE_FORMAT(a.DSI_Try, '%Y-%m-%d') 启用时间,c.SHOP_Address 设备位置,b.DDI_Type 设备类型
		from study.t_device_sub_info a left join t_device_device_info b
		on a.DDI_No = b.DDI_No
		left join netfiance_db.t_shop_shop_info c
		on a.SHOP_No = c.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON c.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join study.t_shop_sub_info d
		on c.SHOP_Uid = d.SHOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = c.SHOP_Class
		where a.DDI_No = #{ddiNo}
		#and a.DDI_No = '{{设备编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and b.DDI_Type = '{{ 设备类型 }}'
		#and a.SHOP_No = '{{ 网点编号 }}'
		and date(a.DSI_Try) >= #{startDate} and date(a.DSI_Try) &lt;= #{endDate}
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and d.SHOP_Area = '{{ 所属地区 }}'

		LIMIT 1
	</select>

	<!-- 添加where查询条件。添加LIMIT 1控制只能显示一条数据 -->
	<select id="mdsxxx" parameterType="String" resultType = "java.util.HashMap">
		select a.SHOP_No 网点编号,a.SHOP_Title 网点名称,a.SHOP_Address 详细地址,c.SHOP_Area 所属区域,a.SHOP_Position GIS位置,t.DICT_Name 门店类型,c.SHOP_Traffic 门店每日人流量,c.SHOP_Consume 人均消费,c.SHOP_Distance 距公司距离,c.SHOP_ShoppingCenter 所属商圈,c.SHOP_OpenTime 网点开门时间,c.SHOP_CloseTime 网点关门时间,c.SHOP_AreaManager 所属区域经理,c.SHOP_Withdraw 撤店时间
		from  netfiance_db.t_shop_shop_info a
		left join study.t_shop_sub_info c
		on a.SHOP_Uid = c.SHOP_Uid
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON a.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join t_device_device_info d
		on d.DDI_SPUid = a.SHOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = a.SHOP_Class
		where a.SHOP_No = #{shopNo}
		#and SHOP_No = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and d.DDI_Type = '{{ 设备类型 }}'
		#and a.SHOP_No = '{{ 网点编号 }}'
		and date(a.CreateDate) >= #{startDate} and date(a.CreateDate) &lt;= #{endDate}
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and c.SHOP_Area  = '{{ 所属地区 }}'
	</select>

	<!-- 运营状态信息-1 -->
	<select id="yyzt1" resultType="java.util.HashMap">
		select a.DDI_No 设备编号,a.SHOP_No 网点编号,a.DSI_Try 设备启用时间,d.SHOP_Apply 网点申请时间,a.DSI_Withdraw 设备撤出时间,
		m.DICT_Name 设备目前状态,t.DICT_Name '目前门店状态',g.ATOP_Title 所属渠道,q.DICT_Name 合作类型
		from study.t_device_sub_info a left join netfiance_db.t_shop_shop_info b
		on a.SHOP_No = b.SHOP_No
		left join t_device_device_info c
		on c.DDI_No = a.DDI_No
		left join study.t_shop_sub_info d
		on a.SHOP_No = d.SHOP_No
		left join netfiance_db.t_shop_device_list n
		on n.DVLS_Uid = c.DDI_Uid
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON b.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_state' ) m
		on m.DICT_Value = n.DVLS_State
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_state' ) t
		on t.DICT_Value = b.SHOP_State
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) p
		on p.DICT_Value = b.SHOP_Class
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_type' ) q
		on q.DICT_Value = b.SHOP_Type
		where c.DDI_No = #{ddiNo}
		#and a.SHOP_No = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and c.DDI_Type = '{{ 设备类型 }}'
		and date(a.DSI_Try) >= #{startDate} and date(a.DSI_Try) &lt;= #{endDate}
		#and p.DICT_Name = '{{ 网点类型 }}'
		#and d.SHOP_Area = '{{ 所属地区 }}'
	</select>

	<!-- 运营状态信息-2 -->
	<select id="yyzt2" resultType="java.util.HashMap">
		select b.DDI_No,c.SHOP_No,date(e.DSI_Try) 启用时间,round(sum(a.DOL_Length)/60,1) last_hour,count(distinct(date(a.DOL_Start))) '累计开机天数',round(sum(a.DOL_Length)/60/count(distinct(date(a.DOL_Start))),1) '日均开机时长（小时）',
		timestampdiff(day,date(e.DSI_Try),curdate())+1-count(distinct(date(a.DOL_Start))) '累计关机天数',(timestampdiff(day,date(e.DSI_Try),curdate())+1-count(distinct(date(a.DOL_Start))))/(timestampdiff(month,date(e.DSI_Try),curdate())+1) '月均关机天数'
		from t_device_online_list a left join t_device_device_info b
		on a.DOL_DUid = b.DDI_Uid
		left join study.t_device_sub_info e
		on b.DDI_No = e.DDI_No
		left join netfiance_db.t_shop_shop_info c
		on e.SHOP_No = c.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON c.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join study.t_shop_sub_info d
		on c.SHOP_No = d.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = c.SHOP_Class
		where DOL_Length &lt;> 0
		and a.CreateDate >= e.DSI_Try and (a.CreateDate &lt;= e.DSI_Withdraw or e.DSI_Withdraw is null)
		and b.DDI_No = #{ddiNo}
		#and c.SHOP_No = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and b.DDI_Type = '{{ 设备类型 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and d.SHOP_Area = '{{ 所属地区 }}'
		group by SHOP_Title,b.DDI_No,启用时间
	</select>

	<!-- 运营状态信息-3   机器获客总人数 -->
	<select id="yyzt3_jqhkzrs" resultType="java.util.HashMap">
		select DDI_No 设备编号,SHOP_No 网点编号,启用时间,count(ODER_USUid) 机器获客总人数
		from
		(select a.ODER_USUid,a.ODER_Uid,t.DDI_No,c.SHOP_No,date(m.DSI_Try) 启用时间,min(a.CreateDate)
		from t_shop_order_info a left join netfiance_db.t_shop_shop_info c
		on a.ODER_SPUid = c.SHOP_Uid
		left join study.t_shop_sub_info d
		on c.SHOP_No = d.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON c.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		join t_customer_user_info e
		on a.ODER_USUid = e.USER_Uid
		join t_device_device_info t
		on a.ODER_DUid = t.DDI_Uid
		left join study.t_device_sub_info m
		on t.DDI_No = m.DDI_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) p
		on p.DICT_Value = c.SHOP_Class
		where  ODER_State = 0
		and USER_Type = 2
		and a.CreateDate >= m.DSI_Try and (a.CreateDate &lt;= m.DSI_Withdraw or m.DSI_Withdraw is null)
		and t.DDI_No = #{ddiNo}
		and date(e.CreateDate) >= #{startDate} and date(e.CreateDate) &lt;= #{endDate}
		#and SHOP_No = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and t.DDI_Type = '{{ 设备类型 }}'
		#and p.DICT_Name = '{{ 网点类型 }}'
		#and d.SHOP_Area = '{{ 所属地区 }}'
		group by a.ODER_USUid ) t

		group by 设备编号,网点编号,启用时间

	</select>

	<!-- 运营状态信息-3   机器日均购彩人数 -->
	<select id="yyzt3_jqrjgcrs" resultType="java.util.HashMap">
		select DDI_No,SHOP_No,启用时间,sum(每日购彩用户数) 累计购彩人数,查询时段内运营天数,sum(每日购彩用户数)/查询时段内运营天数 '机器日均购彩人数'
		from
		(
		select c.DDI_No,c.SHOP_No,date(c.DSI_Try) 启用时间,date(a.CreateDate) dt,count(distinct(a.ODER_USUid)) 每日购彩用户数,
		case when date(c.DSI_Try) >= #{startDate} then datediff(#{endDate}, #{startDate})+1
		else datediff(#{endDate},date(c.DSI_Try))+1 end as '查询时段内运营天数'
		from t_shop_order_info a left join t_device_device_info b
		on a.ODER_DUid = b.DDI_Uid
		left join study.t_device_sub_info c
		on b.DDI_No = c.DDI_No
		left join netfiance_db.t_shop_shop_info d
		on a.ODER_SPUid = d.SHOP_Uid
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON d.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join study.t_shop_sub_info e
		on d.SHOP_No = e.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = d.SHOP_Class
		where a.CreateDate >= c.DSI_Try and (a.CreateDate &lt;= c.DSI_Withdraw or c.DSI_Withdraw is null)
		and a.ODER_State = 0
		and c.DSI_Anti is null
		and b.DDI_No = #{ddiNo}
		and date(a.CreateDate)>= #{startDate} and date(a.CreateDate)  &lt;= #{endDate}
		#and d.SHOP_No = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and b.DDI_Type = '{{ 设备类型 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and e.SHOP_Area = '{{ 所属地区 }}'
		group by DDI_No,SHOP_No,启用时间   ) sheet

	</select>

	<!-- 运营状态信息-3   机器日均新购彩人数 -->
	<select id="yyzt3_jqrjxgcrs" resultType="java.util.HashMap">
		select DDI_No,SHOP_No,启用时间,sum(每日购彩用户数) 累计购彩人数,查询时段内运营天数,sum(每日购彩用户数)/查询时段内运营天数 '机器日均购彩人数'
		from
		(
		select c.DDI_No,c.SHOP_No,date(c.DSI_Try) 启用时间,date(a.CreateDate) dt,count(distinct(a.ODER_USUid)) 每日购彩用户数,
		case when date(c.DSI_Try)>= #{startDate}  then datediff(#{endDate} ,#{startDate} )+1
		else datediff(#{endDate} ,date(c.DSI_Try))+1 end as '查询时段内运营天数'
		from t_shop_order_info a left join t_device_device_info b
		on a.ODER_DUid = b.DDI_Uid
		left join study.t_device_sub_info c
		on b.DDI_No = c.DDI_No
		left join netfiance_db.t_shop_shop_info d
		on a.ODER_SPUid = d.SHOP_Uid
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON d.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join study.t_shop_sub_info e
		on d.SHOP_No = e.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = d.SHOP_Class
		left join t_customer_user_info h
		on a.ODER_USUid = h.USER_Uid
		where a.CreateDate >= c.DSI_Try and (a.CreateDate &lt;= c.DSI_Withdraw or c.DSI_Withdraw is null)
		and a.ODER_State = 0
		and c.DSI_Anti is null
		and a.CreateDate &lt;= h.CreateDate
		and and b.DDI_No = #{ddiNo}
		and date(a.CreateDate)>= #{startDate}  and date(a.CreateDate) &lt;= #{endDate}
		#and d.SHOP_No = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and b.DDI_Type = '{{ 设备类型 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and e.SHOP_Area = '{{ 所属地区 }}'
		group by DDI_No,SHOP_No,启用时间   ) sheet

	</select>


	<!-- 运营状态信息-3   机器日均复购人数 -->
	<select id="yyzt3_jqrjfgrs" resultType="java.util.HashMap">
		select DDI_No,SHOP_No,启用时间,sum(每日购彩用户数) 累计购彩人数,查询时段内运营天数,sum(每日购彩用户数)/查询时段内运营天数 '机器日均购彩人数'
		from
		(
		select c.DDI_No,c.SHOP_No,date(c.DSI_Try) 启用时间,date(a.CreateDate) dt,count(distinct(a.ODER_USUid)) 每日购彩用户数,
		case when date(c.DSI_Try)>= #{startDate}  then datediff(#{endDate} ,#{startDate} )+1
		else datediff(#{endDate} ,date(c.DSI_Try))+1 end as '查询时段内运营天数'
		from t_shop_order_info a left join t_device_device_info b
		on a.ODER_DUid = b.DDI_Uid
		left join study.t_device_sub_info c
		on b.DDI_No = c.DDI_No
		left join netfiance_db.t_shop_shop_info d
		on a.ODER_SPUid = d.SHOP_Uid
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON d.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join study.t_shop_sub_info e
		on d.SHOP_No = e.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = d.SHOP_Class
		left join t_customer_user_info h
		on a.ODER_USUid = h.USER_Uid
		where a.CreateDate >= c.DSI_Try and (a.CreateDate &lt;= c.DSI_Withdraw or c.DSI_Withdraw is null)
		and a.ODER_State = 0
		and c.DSI_Anti is null
		and a.CreateDate > h.CreateDate
		and b.DDI_No = #{ddiNo}
		and dt>= #{startDate}  and dt &lt;= #{endDate}
		#and d.SHOP_No = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and b.DDI_Type = '{{ 设备类型 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and e.SHOP_Area = '{{ 所属地区 }}'
		group by DDI_No,SHOP_No,启用时间   ) sheet

	</select>

	<!-- 设备维护统计3 -->
	<select id="sbwhtj3" resultType="java.util.HashMap">
		select a.updated_at 加仓时间, a.created_at as 出库日期, k.DDI_No as 设备,k.SHOP_No,date(k.DSI_Try) 启用时间,a.package_no as 出库包裹号,e.COUP_Title 彩票名称,e.COUP_Money*b.lottery_count*count(a.package_no) 加票额度（元）
		,e.COUP_Money 票种面额（元）, b.lottery_count*count(a.package_no) as 加票张数, c.user_nickname as 姓名
		from t_storage_checkout_packages a join t_storage_checkout_packages_detail b
		on a.package_no = b.package_no
		left join t_customer_user_info c
		on a.delivery_id = c.user_uid
		left join t_customer_coupon_sub_info d
		on left(b.lottery_start_id,5) = d.COUPS_Prefix
		left join t_customer_coupon_info e
		on d.COUPS_CPUid = e.COUP_Uid
		left join t_device_device_info h
		on a.device_no = h.DDI_No
		left join study.t_device_sub_info k
		on h.DDI_No = k. DDI_No
		left join netfiance_db.t_shop_shop_info i
		on k.SHOP_No = i.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON i.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join study.t_shop_sub_info j
		on i.SHOP_No = j.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = i.SHOP_Class
		where a.updated_at >= k.DSI_Try and (a.updated_at &lt;= k.DSI_Withdraw or k.DSI_Withdraw is null)
		and k.DSI_Anti is null
		and h.DDI_No = #{ddiNo}
		and date(a.updated_at) >= #{startDate}  and date(a.updated_at) &lt;= #{endDate}
		#and i.SHOP_No = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and h.DDI_Type = '{{ 设备类型 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		group by a.package_no,e.COUP_Title
		order by a.created_at

	</select>

	<!-- 设备维护统计4 -->
	<select id="sbwhtj4" resultType="java.util.HashMap">
		select c.DDI_No 设备编码,c.SHOP_No 网点编码,DSL_No 机头编号,date(c.DSI_Try) 启用时间,d.COUP_Title 仓内票种,d.COUP_Money 票种金额,a.DSL_Count 实时余量
		from t_device_sub_list a left join t_device_device_info b
		on a.DSL_DUid = b.DDI_Uid
		left join study.t_device_sub_info c
		on b.DDI_No = c.DDI_No
		join t_customer_coupon_info d
		on a.DSL_CPUid = d.COUP_Uid
		left join netfiance_db.t_shop_shop_info i
		on c.SHOP_No= i.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON i.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join study.t_shop_sub_info j
		on i.SHOP_No = j.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = i.SHOP_Class
		where c.DSI_Anti is null
		and a.ModifyDate >= c.DSI_Try and (a.ModifyDate &lt;= c.DSI_Withdraw or c.DSI_Withdraw is null)
		and b.DDI_No = #{ddiNo}
		#and c.SHOP_No = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and b.DDI_Type = '{{ 设备类型 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		order by 设备编码,DSL_No

	</select>

	<!-- 设备维护统计5 -->
	<select id="sbwhtj5" resultType="java.util.HashMap">
		select device_no as 设备,c.DSL_No 票仓,count(distinct(a.package_no)) as 加仓次数
		from t_storage_checkout_packages a join t_storage_checkout_packages_detail b
		on a.package_no = b.package_no
		left join t_device_sub_list c
		on c.DSL_Uid = b.warehouse_id
		left join t_device_device_info h
		on a.device_no = h.DDI_No
		left join netfiance_db.t_shop_shop_info i
		on h.DDI_SPUid = i.SHOP_Uid
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON i.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join study.t_shop_sub_info j
		on i.SHOP_No = j.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = i.SHOP_Class
		where h.DDI_No = #{ddiNo}
		and date(a.updated_at) >= #{startDate}  and date(a.updated_at) &lt;= #{endDate}
		#and i.SHOP_No = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and h.DDI_Type = '{{ 设备类型 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		group by device_no,c.DSL_No

	</select>

	<!-- 设备交易信息-销售 -->
	<select id="sbjyxx_xs" resultType="java.util.HashMap" >
		select c.DDI_No 设备编号,c.SHOP_No 网点编号,date(c.DSI_Try) 启用时间,sum(b.ODDT_Money*b.ODDT_Count) 累计销售额（元）,sum(b.ODDT_Count) 累计销售票数（张）,count(distinct(a.ODER_Uid)) 累计订单数（单）
		from t_shop_order_info a left join t_shop_order_detail b
		on a.ODER_Uid = b.ODDT_ODUid
		left join t_device_device_info h
		on a.ODER_DUid = h.DDI_Uid
		left join study.t_device_sub_info c
		on c.DDI_No = h.DDI_No
		left join netfiance_db.t_shop_shop_info i
		on c.SHOP_No = i.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON i.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) p
		on p.DICT_Value = i.SHOP_Class
		left join study.t_shop_sub_info j
		on i.SHOP_No = j.SHOP_No
		where c.DSI_Anti is null
		and a.ODER_State = 0
		and a.CreateDate >= c.DSI_Try and (a.CreateDate &lt;= c.DSI_Withdraw or c.DSI_Withdraw is null)
		and c.DDI_No = #{ddiNo}
		and date(a.CreateDate) >= #{startDate}  and date(a.CreateDate) &lt;= #{endDate}
		#and c.SHOP_No  = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and h.DDI_Type = '{{ 设备类型 }}'
		#and p.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		group by 设备编号,网点编号,启用时间;

	</select>

	<!-- 设备交易信息-退款 -->
	<select id="sbjyxx_tk" resultType="java.util.HashMap" >
		select e.DDI_No 设备编号,e.SHOP_No 网点编号,date(e.DSI_Try) 启动时间,count(distinct(c.ODER_Uid)) 累计退款订单数,sum(a.FLRF_RefundMoney) 累计退款额,count(distinct(c.ODER_USUid)) 累计退款人数
		from netfiance_db.t_finance_bank_refund a left join netfiance_db.t_finance_bank_flow b
		on a.FLRF_FLUid = b.FLOW_Uid
		left join t_shop_order_info c
		on b.FLOW_OrderId = c.ODER_Note
		left join t_device_device_info d
		on c.ODER_DUid = d.DDI_Uid
		left join study.t_device_sub_info e
		on d.DDI_No = e.DDI_No
		left join netfiance_db.t_shop_shop_info i
		on e.SHOP_No = i.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON i.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) p
		on p.DICT_Value = i.SHOP_Class
		left join study.t_shop_sub_info j
		on i.SHOP_No = j.SHOP_No
		where c.ODER_State = 0
		and e.DSI_Anti is null
		and a.CreateDate >= e.DSI_Try and (a.CreateDate &lt;= e.DSI_Withdraw or e.DSI_Withdraw is null)
		and d.DDI_No = #{ddiNo}
		and date(a.CreateDate) >= #{startDate}  and date(a.CreateDate) &lt;= #{endDate}
		#and i.SHOP_No  = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and h.DDI_Type = '{{ 设备类型 }}'
		#and p.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		group by 设备编号,网点编号,启动时间

	</select>

	<!-- 设备交易信息-退款订单比率 -->
	<select id="sbjyxx_tkddbl" resultType="java.util.HashMap" >
		select d.DDI_No 设备编号,d.SHOP_No 网点编号,date(d.DSI_Try) 启用时间,count(distinct(c.FLRF_Uid))/count(distinct(a.ODER_Uid)) 退款订单比率
		from t_shop_order_info a left join netfiance_db.t_finance_bank_flow b
		on a.ODER_Note = b.FLOW_OrderId
		left join netfiance_db.t_finance_bank_refund c
		on b.FLOW_Uid = c.FLRF_FLUid
		left join t_device_device_info h
		on a.ODER_DUid = h.DDI_Uid
		left join study.t_device_sub_info d
		on h.DDI_No = d.DDI_No
		left join netfiance_db.t_shop_shop_info i
		on d.SHOP_No = i.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON i.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) p
		on p.DICT_Value = i.SHOP_Class
		left join study.t_shop_sub_info j
		on i.SHOP_No = j.SHOP_No
		where d.DSI_Anti is null
		and a.ODER_State = 0
		and a.CreateDate >= d.DSI_Try and (a.CreateDate &lt;= d.DSI_Withdraw or d.DSI_Withdraw is null)
		and d.DDI_No = #{ddiNo}
		and date(a.CreateDate) >= #{startDate}  and date(a.CreateDate) &lt;= #{endDate}
		#and d.SHOP_No  = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and h.DDI_Type = '{{ 设备类型 }}'
		#and p.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		group by 设备编号,网点编号,启用时间

	</select>

	<!-- 设备交易信息-当日销售 -->
	<select id="sbjyxx_drxs" resultType="java.util.HashMap" >
		select c.DDI_No 设备编号,c.SHOP_No 网点编号,date(c.DSI_Try) 启用时间,sum(b.ODDT_Money*b.ODDT_Count) 当日销售额（元）,sum(b.ODDT_Count) 当日销售票数（张）,count(distinct(a.ODER_Uid)) 当日订单数（单）,max(a.ODER_Money) 当日最大订单额度
		from t_shop_order_info a left join t_shop_order_detail b
		on a.ODER_Uid = b.ODDT_ODUid
		left join t_device_device_info h
		on a.ODER_DUid = h.DDI_Uid
		left join study.t_device_sub_info c
		on c.DDI_No = h.DDI_No
		left join netfiance_db.t_shop_shop_info i
		on c.SHOP_No = i.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON i.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) p
		on p.DICT_Value = i.SHOP_Class
		left join study.t_shop_sub_info j
		on i.SHOP_No = j.SHOP_No
		where c.DSI_Anti is null
		and a.ODER_State = 0
		and a.CreateDate >= c.DSI_Try and (a.CreateDate &lt;= c.DSI_Withdraw or c.DSI_Withdraw is null)
		and date(a.CreateDate) = curdate()
		and c.DDI_No = #{ddiNo}
		#and c.SHOP_No  = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and h.DDI_Type = '{{ 设备类型 }}'
		#and p.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		group by 设备编号,网点编号,启用时间;

	</select>

	<!-- 设备交易信息-当日退款 -->
	<select id="sbjyxx_drtk" resultType="java.util.HashMap" >
		select e.DDI_No 设备编号,e.SHOP_No 网点编号,date(e.DSI_Try) 启动时间,count(distinct(c.ODER_Uid)) 当日退款订单数,sum(a.FLRF_RefundMoney) 当日退款额,count(distinct(c.ODER_USUid)) 当日退款人数
		from netfiance_db.t_finance_bank_refund a left join netfiance_db.t_finance_bank_flow b
		on a.FLRF_FLUid = b.FLOW_Uid
		left join t_shop_order_info c
		on b.FLOW_OrderId = c.ODER_Note
		left join t_device_device_info d
		on c.ODER_DUid = d.DDI_Uid
		left join study.t_device_sub_info e
		on d.DDI_No = e.DDI_No
		left join netfiance_db.t_shop_shop_info i
		on e.SHOP_No = i.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON i.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) p
		on p.DICT_Value = i.SHOP_Class
		left join study.t_shop_sub_info j
		on i.SHOP_No = j.SHOP_No
		where c.ODER_State = 0
		and e.DSI_Anti is null
		and a.CreateDate >= e.DSI_Try and (a.CreateDate &lt;= e.DSI_Withdraw or e.DSI_Withdraw is null)
		and date(a.CreateDate) = curdate()
		and d.DDI_No = #{ddiNo}
		#and i.SHOP_No  = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and h.DDI_Type = '{{ 设备类型 }}'
		#and p.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		group by 设备编号,网点编号,启动时间

	</select>

	<!-- 设备交易信息-当日票种销量 -->
	<select id="sbjyxx_drpzxl" resultType="java.util.HashMap" >
		select b.DDI_No 设备编号,b.SHOP_No 网点编号,date(b.DSI_Try) 启用时间,o.COUP_Title as 票种名称,o.COUP_Money 票种单价,sum(m.ODDT_Count)  累计销售张数,sum(o.COUP_Money*m.ODDT_Count) 累计销售金额
		from t_shop_order_detail m join t_shop_order_info n
		on n.ODER_Uid = m.ODDT_ODUid
		join t_customer_coupon_info o
		on m.ODDT_LTUid=o.COUP_Uid
		left join t_device_device_info a
		on n.ODER_DUid = a.DDI_Uid
		left join study.t_device_sub_info b
		on a.DDI_No = b.DDI_No
		left join netfiance_db.t_shop_shop_info e
		on b.SHOP_No = e.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON e.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) p
		on p.DICT_Value = e.SHOP_Class
		left join study.t_shop_sub_info j
		on e.SHOP_No = j.SHOP_No
		where date(n.CreateDate) >= #{startDate}  and date(n.CreateDate) &lt;= #{endDate}
		and ODER_State = 0
		and b.DSI_Anti is null
		and n.CreateDate >= b.DSI_Try and (n.CreateDate &lt;= b.DSI_Withdraw or b.DSI_Withdraw is null)
		and a.DDI_No = #{ddiNo}
		#and e.SHOP_No = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and a.DDI_Type = '{{ 设备类型 }}'
		#and p.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		group by 设备编号,网点编号,启用时间,票种名称

	</select>

	
</mapper>
