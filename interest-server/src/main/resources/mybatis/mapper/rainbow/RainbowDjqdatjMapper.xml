<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.interest.dao.rainbow.RainbowDjqdatjDao">

	<!-- 机器属性信息，添加分页 -->
	<select id="jqsxxx_list"  resultType="java.util.HashMap">
		select a.DDI_No 机器编号,a.SHOP_No 网点编号, DATE_FORMAT(a.DSI_Try, '%Y-%m-%d') 启用时间,c.SHOP_Address 设备位置,b.DDI_Type 设备类型
		from study.t_device_sub_info a left join t_device_device_info b
		on a.DDI_No = b.DDI_No
		left join netfiance_db.t_shop_shop_info c
		on a.SHOP_No = c.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON c.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join study.t_shop_sub_info d
		on c.SHOP_Uid = d.SHOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = c.SHOP_Class

		where 1=1

		<if test="null != filterMap.startDate">
			and date(a.DSI_Try) >= #{filterMap.startDate}
		</if>
		<if test="null != filterMap.endDate">
			and date(a.DSI_Try) &lt;= #{filterMap.endDate}
		</if>
		<if test="null != filterMap.deviceTypeValue">
			and b.DDI_Type = #{filterMap.deviceTypeValue}
		</if>
		<if test="null != filterMap.areaValue">
			and d.SHOP_Area = #{filterMap.areaValue}
		</if>
		<if test="null != filterMap.channelValue">
			and g.ATOP_Title = #{filterMap.channelValue}
		</if>
		<if test="null != filterMap.shopValue">
			and a.SHOP_No = #{filterMap.shopValue}
		</if>

		limit #{pageWrapper.start},#{pageWrapper.pageSize};
	</select>

	<!-- 有改动，添加count -->
	<select id="jqsxxx_list_count" resultType = "Integer">
		select count(a.DDI_No)
		from study.t_device_sub_info a left join t_device_device_info b
		on a.DDI_No = b.DDI_No
		left join netfiance_db.t_shop_shop_info c
		on a.SHOP_No = c.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON c.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join study.t_shop_sub_info d
		on c.SHOP_Uid = d.SHOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = c.SHOP_Class

		where 1=1

		<if test="null != filterMap.startDate">
			and date(a.DSI_Try) >= #{filterMap.startDate}
		</if>
		<if test="null != filterMap.endDate">
			and date(a.DSI_Try) &lt;= #{filterMap.endDate}
		</if>
		<if test="null != filterMap.deviceTypeValue">
			and b.DDI_Type = #{filterMap.deviceTypeValue}
		</if>
		<if test="null != filterMap.areaValue">
			and d.SHOP_Area = #{filterMap.areaValue}
		</if>
		<if test="null != filterMap.channelValue">
			and g.ATOP_Title = #{filterMap.channelValue}
		</if>
		<if test="null != filterMap.shopValue">
			and a.SHOP_No = #{filterMap.shopValue}
		</if>

		#and a.DDI_No = '{{设备编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and b.DDI_Type = '{{ 设备类型 }}'
		#and a.SHOP_No = '{{ 网点编号 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and d.SHOP_Area = '{{ 所属地区 }}'
	</select>

	<!-- 添加where查询条件。添加LIMIT 1控制只能显示一条数据 -->
	<select id="jqsxxx"  resultType = "java.util.HashMap">
		select a.DDI_No 机器编号,a.SHOP_No 网点编号,DATE_FORMAT(a.DSI_Try, '%Y-%m-%d') 启用时间,c.SHOP_Address 设备位置,b.DDI_Type 设备类型
		from study.t_device_sub_info a left join t_device_device_info b
		on a.DDI_No = b.DDI_No
		left join netfiance_db.t_shop_shop_info c
		on a.SHOP_No = c.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON c.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join study.t_shop_sub_info d
		on c.SHOP_Uid = d.SHOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = c.SHOP_Class
		where 1=1

		and date(a.DSI_Try) >= #{filterMap.startDate} and date(a.DSI_Try) &lt;= #{filterMap.endDate}

		<if test="null != filterMap.ddiNo">
			and a.DDI_No = #{filterMap.ddiNo}
		</if>
		<if test="null != filterMap.channelValue">
			and g.ATOP_Title = #{filterMap.channelValue}
		</if>
		<if test="null != filterMap.deviceTypeValue">
			and b.DDI_Type = #{filterMap.deviceTypeValue}
		</if>
		<if test="null != filterMap.areaValue">
			and d.SHOP_Area = #{filterMap.areaValue}
		</if>
		<if test="null != filterMap.shopTypeValue">
			and t.DICT_Name = #{filterMap.shopTypeValue}
		</if>
		<if test="null != filterMap.shopValue">
			and a.SHOP_No = #{filterMap.shopValue}
		</if>

		#and a.DDI_No = '{{设备编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and b.DDI_Type = '{{ 设备类型 }}'
		#and a.SHOP_No = '{{ 网点编号 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and d.SHOP_Area = '{{ 所属地区 }}'

		LIMIT 1
	</select>

	<!-- 添加where查询条件。添加LIMIT 1控制只能显示一条数据 -->
	<select id="mdsxxx"  resultType = "java.util.HashMap">
		select a.SHOP_No 网点编号,a.SHOP_Title 网点名称,a.SHOP_Address 详细地址,c.SHOP_Area 所属区域,a.SHOP_Position GIS位置,t.DICT_Name 门店类型,c.SHOP_Traffic 门店每日人流量,c.SHOP_Consume 人均消费,c.SHOP_Distance 距公司距离,c.SHOP_ShoppingCenter 所属商圈,c.SHOP_OpenTime 网点开门时间,c.SHOP_CloseTime 网点关门时间,c.SHOP_AreaManager 所属区域经理,c.SHOP_Withdraw 撤店时间
		from  netfiance_db.t_shop_shop_info a
		left join study.t_shop_sub_info c
		on a.SHOP_Uid = c.SHOP_Uid
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON a.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join t_device_device_info d
		on d.DDI_SPUid = a.SHOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = a.SHOP_Class

		where 1=1

		<if test="null != filterMap.channelValue">
			and g.ATOP_Title = #{filterMap.channelValue}
		</if>
		<if test="null != filterMap.deviceTypeValue">
			and d.DDI_Type = #{filterMap.deviceTypeValue}
		</if>
		<if test="null != filterMap.areaValue">
			and c.SHOP_Area = #{filterMap.areaValue}
		</if>
		<if test="null != filterMap.shopTypeValue">
			and p.DICT_Name = #{filterMap.shopTypeValue}
		</if>
		<if test="null != filterMap.shopValue">
			and a.SHOP_No = #{filterMap.shopValue}
		</if>


		#where a.SHOP_No = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and d.DDI_Type = '{{ 设备类型 }}'
		#and a.SHOP_No = '{{ 网点编号 }}'
		#and date(a.CreateDate) >='{{ 起始时间 }}' and date(a.CreateDate) &lt;='{{ 截止时间 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and c.SHOP_Area  = '{{ 所属地区 }}'

	</select>

	<!-- 运营状态信息-1 -->
	<select id="yyzt1" resultType="java.util.HashMap">
		select a.DDI_No 设备编号,a.SHOP_No 网点编号,DATE_FORMAT(a.DSI_Try, '%Y-%m-%d') 设备启用时间,d.SHOP_Apply 网点申请时间,a.DSI_Withdraw 设备撤出时间,
		m.DICT_Name 设备目前状态,t.DICT_Name '目前门店状态',g.ATOP_Title 所属渠道,q.DICT_Name 合作类型
		from study.t_device_sub_info a left join netfiance_db.t_shop_shop_info b
		on a.SHOP_No = b.SHOP_No
		left join t_device_device_info c
		on c.DDI_No = a.DDI_No
		left join study.t_shop_sub_info d
		on a.SHOP_No = d.SHOP_No
		left join netfiance_db.t_shop_device_list n
		on n.DVLS_Uid = c.DDI_Uid
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON b.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_state' ) m
		on m.DICT_Value = n.DVLS_State
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_state' ) t
		on t.DICT_Value = b.SHOP_State
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) p
		on p.DICT_Value = b.SHOP_Class
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_type' ) q
		on q.DICT_Value = b.SHOP_Type
		where 1=1

		and date(a.DSI_Try) >= #{filterMap.startDate} and date(a.DSI_Try) &lt;= #{filterMap.endDate}

		<if test="null != filterMap.ddiNo">
			and c.DDI_No = #{filterMap.ddiNo}
		</if>
		<if test="null != filterMap.channelValue">
			and g.ATOP_Title = #{filterMap.channelValue}
		</if>
		<if test="null != filterMap.deviceTypeValue">
			and c.DDI_Type = #{filterMap.deviceTypeValue}
		</if>
		<if test="null != filterMap.areaValue">
			and d.SHOP_Area = #{filterMap.areaValue}
		</if>
		<if test="null != filterMap.shopTypeValue">
			and p.DICT_Name = #{filterMap.shopTypeValue}
		</if>
		<if test="null != filterMap.shopValue">
			and a.SHOP_No = #{filterMap.shopValue}
		</if>

		#and a.SHOP_No = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and c.DDI_Type = '{{ 设备类型 }}'
		#and p.DICT_Name = '{{ 网点类型 }}'
		#and d.SHOP_Area = '{{ 所属地区 }}'
	</select>

	<!-- 运营状态信息-2 -->
	<select id="yyzt2" resultType="java.util.HashMap">
		select b.DDI_No 机器编号,c.SHOP_No 网点编号,date(e.DSI_Try) 启用时间,round(sum(a.DOL_Length)/60, 1) 设备累计开机时间（时）,count(distinct(date(a.DOL_Start))) 累计开机天数,round(sum(a.DOL_Length)/60/count(distinct(date(a.DOL_Start))),1) '日均开机时长（小时）',
		timestampdiff(day,date(e.DSI_Try),curdate())+1-count(distinct(date(a.DOL_Start))) '累计关机天数',(timestampdiff(day,date(e.DSI_Try),curdate())+1-count(distinct(date(a.DOL_Start))))/(timestampdiff(month,date(e.DSI_Try),curdate())+1) '月均关机天数'
		from t_device_online_list a left join t_device_device_info b
		on a.DOL_DUid = b.DDI_Uid
		left join study.t_device_sub_info e
		on b.DDI_No = e.DDI_No
		left join netfiance_db.t_shop_shop_info c
		on e.SHOP_No = c.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON c.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join study.t_shop_sub_info d
		on c.SHOP_No = d.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = c.SHOP_Class
		where DOL_Length &lt;> 0
		and a.CreateDate >= e.DSI_Try and (a.CreateDate &lt;= e.DSI_Withdraw or e.DSI_Withdraw is null)

		<if test="null != filterMap.shopValue">
			and c.SHOP_No = #{filterMap.shopValue}
		</if>
		<if test="null != filterMap.ddiNo">
			and b.DDI_No = #{filterMap.ddiNo}
		</if>
		<if test="null != filterMap.channelValue">
			and g.ATOP_Title = #{filterMap.channelValue}
		</if>
		<if test="null != filterMap.deviceTypeValue">
			and b.DDI_Type = #{filterMap.deviceTypeValue}
		</if>
		<if test="null != filterMap.areaValue">
			and d.SHOP_Area = #{filterMap.areaValue}
		</if>
		<if test="null != filterMap.shopTypeValue">
			and t.DICT_Name = #{filterMap.shopTypeValue}
		</if>


		#and c.SHOP_No = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and b.DDI_Type = '{{ 设备类型 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and d.SHOP_Area = '{{ 所属地区 }}'

		group by SHOP_Title,b.DDI_No,启用时间
	</select>

	<!-- 运营状态信息-3   机器获客总人数 -->
	<select id="yyzt3_jqhkzrs" resultType="java.util.HashMap">
		select first_sub.DDI_No,first_sub.SHOP_No,first_sub.dt 启用时间,DDI_Type,ifnull(count(distinct(ODER_USUid)),0) 机器获客总人数
		from
		(select a.DDI_No,a.SHOP_No,date(a.DSI_Try) dt,ifnull(date(a.DSI_Withdraw),now()) draw_dt,b.DDI_Type
		from study.t_device_sub_info a left join t_device_device_info b
		on a.DDI_No = b.DDI_No
		left join netfiance_db.t_shop_shop_info d
		on d.SHOP_No = a.SHOP_No
		left join netfiance_db.t_shop_agent_list e
		on d.SHOP_AGUid = e.AGNT_Uid
		left join netfiance_db.t_shop_agent_top f
		on e.AGNT_ATUid = f.ATOP_Uid
		left join study.t_shop_sub_info g
		on a.SHOP_No = g.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = d.SHOP_Class
		where a.DSI_Anti is null

		<if test="null != filterMap.shopValue">
			and g.SHOP_No = #{filterMap.shopValue}
		</if>
		<if test="null != filterMap.ddiNo">
			and a.DDI_No = #{filterMap.ddiNo}
		</if>
		<if test="null != filterMap.channelValue">
			and f.ATOP_Title = #{filterMap.channelValue}
		</if>
		<if test="null != filterMap.deviceTypeValue">
			and b.DDI_Type = #{filterMap.deviceTypeValue}
		</if>
		<if test="null != filterMap.areaValue">
			and g.SHOP_Area = #{filterMap.areaValue}
		</if>
		<if test="null != filterMap.shopTypeValue">
			and t.DICT_Name = #{filterMap.shopTypeValue}
		</if>

		#and b.DDI_Type = '{{设备类型}}'
		#and f.ATOP_Title = {{选择渠道}}
		#and a.DDI_No = '{{设备编码}}'
		#and g.SHOP_Area = '{{ 所属地区 }}'
		#and d.SHOP_No = '{{ 所属门店 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		order by dt) first_sub             #每台机器在网点真实开启时间

		left join

		(select a.DDI_No,a.SHOP_No,date(a.DSI_Try) dt,e.ODER_Uid,e.ODER_USUid
		from t_shop_order_info e left join t_device_device_info b
		on e.ODER_DUid = b.DDI_Uid
		left join study.t_device_sub_info a
		on b.DDI_No = a.DDI_No
		where date(e.CreateDate)>=#{filterMap.startDate} and date(e.CreateDate) &lt;=#{filterMap.endDate}
		and e.ODER_State = 0
		and e.CreateDate >= a.DSI_Try and (e.CreateDate &lt;= a.DSI_Withdraw or a.DSI_Withdraw is null) ) order_detail
		on first_sub.DDI_No = order_detail.DDI_No and first_sub.SHOP_No = order_detail.SHOP_No and first_sub.dt = order_detail.dt

		where first_sub.dt &lt;=#{filterMap.endDate}
		group by DDI_No,SHOP_No,启用时间


	</select>

	<!-- 运营状态信息-3   机器日均购彩人数 -->
	<select id="yyzt3_jqrjgcrs" resultType="java.util.HashMap">
		select DDI_No 机器编号, SHOP_No 网点编号,启用时间, sum(tol_user) 累计购彩人数, avg(搜索时段内天数) 查询时段内运营天数, ROUND(sum(tol_user)/avg(搜索时段内天数), 2) 机器日均购彩人数
		from
		(
		select first_sub.DDI_No,first_sub.SHOP_No,first_sub.dt 启用时间,day_o,DDI_Type,ifnull(count(distinct(ODER_USUid)),0) tol_user,
		case when first_sub.dt>=#{filterMap.startDate} and first_sub.draw_dt>=#{filterMap.endDate} then datediff(#{filterMap.endDate},first_sub.dt)+1
		when first_sub.dt>=#{filterMap.startDate} and first_sub.draw_dt &lt;#{filterMap.endDate} then datediff(first_sub.draw_dt,first_sub.dt)+1
		when first_sub.draw_dt &lt;#{filterMap.startDate} then 0
		when first_sub.dt &lt;#{filterMap.startDate} and first_sub.draw_dt >= #{filterMap.startDate} and first_sub.draw_dt &lt; #{filterMap.endDate} then datediff(first_sub.draw_dt,#{filterMap.startDate})+1
		when first_sub.dt &lt;#{filterMap.startDate} and first_sub.draw_dt >=#{filterMap.endDate} then datediff(#{filterMap.endDate},#{filterMap.startDate})+1
		when first_sub.dt>#{filterMap.endDate} then 0 end as 搜索时段内天数     #需判断查询起始时间、截止时间，与设备开启时间、撤机时间之间的关系
		from
		(select a.DDI_No,a.SHOP_No,date(a.DSI_Try) dt,ifnull(date(a.DSI_Withdraw),now()) draw_dt,b.DDI_Type
		from study.t_device_sub_info a left join t_device_device_info b
		on a.DDI_No = b.DDI_No
		left join netfiance_db.t_shop_shop_info d
		on d.SHOP_No = a.SHOP_No
		left join netfiance_db.t_shop_agent_list e
		on d.SHOP_AGUid = e.AGNT_Uid
		left join netfiance_db.t_shop_agent_top f
		on e.AGNT_ATUid = f.ATOP_Uid
		left join study.t_shop_sub_info g
		on a.SHOP_No = g.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = d.SHOP_Class
		where a.DSI_Anti is null

		<if test="null != filterMap.shopValue">
			and d.SHOP_No = #{filterMap.shopValue}
		</if>
		<if test="null != filterMap.ddiNo">
			and a.DDI_No = #{filterMap.ddiNo}
		</if>
		<if test="null != filterMap.channelValue">
			and f.ATOP_Title = #{filterMap.channelValue}
		</if>
		<if test="null != filterMap.deviceTypeValue">
			and b.DDI_Type = #{filterMap.deviceTypeValue}
		</if>
		<if test="null != filterMap.areaValue">
			and g.SHOP_Area = #{filterMap.areaValue}
		</if>
		<if test="null != filterMap.shopTypeValue">
			and t.DICT_Name = #{filterMap.shopTypeValue}
		</if>

		#and b.DDI_Type = '{{设备类型}}'
		#and f.ATOP_Title = {{选择渠道}}
		#and a.DDI_No = '{{设备编码}}'
		#and g.SHOP_Area = '{{ 所属地区 }}'
		#and d. SHOP_No = '{{ 所属门店 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		order by dt) first_sub             #每台机器在网点真实开启时间

		left join

		(select a.DDI_No,a.SHOP_No,date(a.DSI_Try) dt,e.ODER_Uid,e.ODER_USUid,date(e.CreateDate) day_o
		from t_shop_order_info e left join t_device_device_info b
		on e.ODER_DUid = b.DDI_Uid
		left join study.t_device_sub_info a
		on b.DDI_No = a.DDI_No
		where date(e.CreateDate)>=#{filterMap.startDate} and date(e.CreateDate) &lt;=#{filterMap.endDate}
		and e.ODER_State = 0
		and e.CreateDate >= a.DSI_Try and (e.CreateDate &lt;= a.DSI_Withdraw or a.DSI_Withdraw is null) ) order_detail
		on first_sub.DDI_No = order_detail.DDI_No and first_sub.SHOP_No = order_detail.SHOP_No and first_sub.dt = order_detail.dt

		where first_sub.dt &lt;=#{filterMap.endDate}

		group by DDI_No,SHOP_No,启用时间,day_o  )t
		group by 机器编号,网点编号,启用时间


	</select>

	<!-- 运营状态信息-3   机器日均新购彩人数 -->
	<select id="yyzt3_jqrjxgcrs" resultType="java.util.HashMap">
		select DDI_No 机器编号, SHOP_No 网点编号,启用时间, sum(tol_user) 新用户总数,avg(搜索时段内天数) 查询时段内运营天数, ROUND(sum(tol_user)/avg(搜索时段内天数), 2) 机器日均新购彩人数
		from
		(
		select first_sub.DDI_No,first_sub.SHOP_No,first_sub.dt 启用时间,day_o,DDI_Type,ifnull(count(distinct(ODER_USUid)),0) tol_user,
		case when first_sub.dt>=#{filterMap.startDate} and first_sub.draw_dt>=#{filterMap.endDate} then datediff(#{filterMap.endDate},first_sub.dt)+1
		when first_sub.dt>=#{filterMap.startDate} and first_sub.draw_dt &lt;#{filterMap.endDate} then datediff(first_sub.draw_dt,first_sub.dt)+1
		when first_sub.draw_dt &lt;#{filterMap.startDate} then 0
		when first_sub.dt &lt;#{filterMap.startDate} and first_sub.draw_dt >= #{filterMap.startDate} and first_sub.draw_dt &lt; #{filterMap.endDate} then datediff(first_sub.draw_dt,#{filterMap.startDate})+1
		when first_sub.dt &lt;#{filterMap.startDate} and first_sub.draw_dt >=#{filterMap.endDate} then datediff(#{filterMap.endDate},#{filterMap.startDate})+1
		when first_sub.dt>#{filterMap.endDate} then 0 end as 搜索时段内天数     #需判断查询起始时间、截止时间，与设备开启时间、撤机时间之间的关系
		from
		(select a.DDI_No,a.SHOP_No,date(a.DSI_Try) dt,ifnull(date(a.DSI_Withdraw),now()) draw_dt,b.DDI_Type
		from study.t_device_sub_info a left join t_device_device_info b
		on a.DDI_No = b.DDI_No
		left join netfiance_db.t_shop_shop_info d
		on d.SHOP_No = a.SHOP_No
		left join netfiance_db.t_shop_agent_list e
		on d.SHOP_AGUid = e.AGNT_Uid
		left join netfiance_db.t_shop_agent_top f
		on e.AGNT_ATUid = f.ATOP_Uid
		left join study.t_shop_sub_info g
		on a.SHOP_No = g.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = d.SHOP_Class
		where a.DSI_Anti is null

		<if test="null != filterMap.shopValue">
			and d.SHOP_No = #{filterMap.shopValue}
		</if>
		<if test="null != filterMap.ddiNo">
			and a.DDI_No = #{filterMap.ddiNo}
		</if>
		<if test="null != filterMap.channelValue">
			and f.ATOP_Title = #{filterMap.channelValue}
		</if>
		<if test="null != filterMap.deviceTypeValue">
			and b.DDI_Type = #{filterMap.deviceTypeValue}
		</if>
		<if test="null != filterMap.areaValue">
			and g.SHOP_Area = #{filterMap.areaValue}
		</if>
		<if test="null != filterMap.shopTypeValue">
			and t.DICT_Name = #{filterMap.shopTypeValue}
		</if>

		#and b.DDI_Type = '{{设备类型}}'
		#and f.ATOP_Title = {{选择渠道}}
		#and a.DDI_No = '{{设备编码}}'
		#and d. SHOP_No = '{{ 所属门店 }}'
		#and g.SHOP_Area = '{{ 所属地区 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		order by dt) first_sub             #每台机器在网点真实开启时间

		left join

		(select a.DDI_No,a.SHOP_No,date(a.DSI_Try) dt,e.ODER_Uid,e.ODER_USUid,date(e.CreateDate) day_o
		from t_shop_order_info e left join t_device_device_info b
		on e.ODER_DUid = b.DDI_Uid
		left join study.t_device_sub_info a
		on b.DDI_No = a.DDI_No
		left join t_customer_user_info h
		on e.ODER_USUid = h.USER_Uid
		where date(e.CreateDate)>=#{filterMap.startDate} and date(e.CreateDate) &lt;=#{filterMap.endDate}
		and e.ODER_State = 0
		and date(e.CreateDate) &lt;= date(h.CreateDate)
		and e.CreateDate >= a.DSI_Try and (e.CreateDate &lt;= a.DSI_Withdraw or a.DSI_Withdraw is null) ) order_detail
		on first_sub.DDI_No = order_detail.DDI_No and first_sub.SHOP_No = order_detail.SHOP_No and first_sub.dt = order_detail.dt

		where first_sub.dt &lt;=#{filterMap.endDate}
		group by DDI_No,SHOP_No,启用时间,day_o  )t
		group by 机器编号,网点编号,启用时间

	</select>


	<!-- 运营状态信息-3   机器日均复购人数 -->
	<select id="yyzt3_jqrjfgrs" resultType="java.util.HashMap">
		select DDI_No 机器编号, SHOP_No 网点编号,启用时间, sum(tol_user) 复购用户总数,avg(搜索时段内天数) 查询时段内运营天数, ROUND(sum(tol_user)/avg(搜索时段内天数), 2) 机器日均复购人数
		from
		(
		select first_sub.DDI_No,first_sub.SHOP_No,first_sub.dt 启用时间,day_o,DDI_Type,ifnull(count(distinct(ODER_USUid)),0) tol_user,
		case when first_sub.dt>=#{filterMap.startDate} and first_sub.draw_dt>=#{filterMap.endDate} then datediff(#{filterMap.endDate},first_sub.dt)+1
		when first_sub.dt>=#{filterMap.startDate} and first_sub.draw_dt &lt;#{filterMap.endDate} then datediff(first_sub.draw_dt,first_sub.dt)+1
		when first_sub.draw_dt &lt;#{filterMap.startDate} then 0
		when first_sub.dt &lt;#{filterMap.startDate} and first_sub.draw_dt >= #{filterMap.startDate} and first_sub.draw_dt &lt; #{filterMap.endDate} then datediff(first_sub.draw_dt,#{filterMap.startDate})+1
		when first_sub.dt &lt;#{filterMap.startDate} and first_sub.draw_dt >=#{filterMap.endDate} then datediff(#{filterMap.endDate},#{filterMap.startDate})+1
		when first_sub.dt>#{filterMap.endDate} then 0 end as 搜索时段内天数     #需判断查询起始时间、截止时间，与设备开启时间、撤机时间之间的关系
		from
		(select a.DDI_No,a.SHOP_No,date(a.DSI_Try) dt,ifnull(date(a.DSI_Withdraw),now()) draw_dt,b.DDI_Type
		from study.t_device_sub_info a left join t_device_device_info b
		on a.DDI_No = b.DDI_No
		left join netfiance_db.t_shop_shop_info d
		on d.SHOP_No = a.SHOP_No
		left join netfiance_db.t_shop_agent_list e
		on d.SHOP_AGUid = e.AGNT_Uid
		left join netfiance_db.t_shop_agent_top f
		on e.AGNT_ATUid = f.ATOP_Uid
		left join study.t_shop_sub_info g
		on a.SHOP_No = g.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = d.SHOP_Class
		where a.DSI_Anti is null

		<if test="null != filterMap.shopValue">
			and d.SHOP_No = #{filterMap.shopValue}
		</if>
		<if test="null != filterMap.ddiNo">
			and a.DDI_No = #{filterMap.ddiNo}
		</if>
		<if test="null != filterMap.channelValue">
			and f.ATOP_Title = #{filterMap.channelValue}
		</if>
		<if test="null != filterMap.deviceTypeValue">
			and b.DDI_Type = #{filterMap.deviceTypeValue}
		</if>
		<if test="null != filterMap.areaValue">
			and g.SHOP_Area = #{filterMap.areaValue}
		</if>
		<if test="null != filterMap.shopTypeValue">
			and t.DICT_Name = #{filterMap.shopTypeValue}
		</if>

		#and b.DDI_Type = '{{设备类型}}'
		#and f.ATOP_Title = {{选择渠道}}
		#and a.DDI_No = '{{设备编码}}'
		#and d. SHOP_No = '{{ 所属门店 }}'
		#and g.SHOP_Area = '{{ 所属地区 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		order by dt) first_sub             #每台机器在网点真实开启时间

		left join

		(select a.DDI_No,a.SHOP_No,date(a.DSI_Try) dt,e.ODER_Uid,e.ODER_USUid,date(e.CreateDate) day_o
		from t_shop_order_info e left join t_device_device_info b
		on e.ODER_DUid = b.DDI_Uid
		left join study.t_device_sub_info a
		on b.DDI_No = a.DDI_No
		left join t_customer_user_info h
		on e.ODER_USUid = h.USER_Uid
		where date(e.CreateDate)>=#{filterMap.startDate} and date(e.CreateDate) &lt;=#{filterMap.endDate}
		and e.ODER_State = 0
		and date(e.CreateDate) > date(h.CreateDate)
		and e.CreateDate >= a.DSI_Try and (e.CreateDate &lt;= a.DSI_Withdraw or a.DSI_Withdraw is null) ) order_detail
		on first_sub.DDI_No = order_detail.DDI_No and first_sub.SHOP_No = order_detail.SHOP_No and first_sub.dt = order_detail.dt

		where first_sub.dt &lt;=#{filterMap.endDate}
		group by DDI_No,SHOP_No,启用时间,day_o  )t
		group by 机器编号,网点编号,启用时间

	</select>

	<!-- 设备维护统计3 -->
	<select id="sbwhtj3" resultType="java.util.HashMap">
		select DATE_FORMAT(a.updated_at, '%Y-%m-%d %H:%i:%s') 加仓时间, DATE_FORMAT(a.created_at, '%Y-%m-%d %H:%i:%s') as 出库日期, k.DDI_No as 设备,k.SHOP_No 网点编号,date(k.DSI_Try) 启用时间,a.package_no as 出库包裹号,e.COUP_Title 彩票名称,e.COUP_Money*b.lottery_count*count(a.package_no) 加票额度（元）
		,e.COUP_Money 票种面额（元）, b.lottery_count*count(a.package_no) as 加票张数, c.user_nickname as 姓名
		from t_storage_checkout_packages a join t_storage_checkout_packages_detail b
		on a.package_no = b.package_no
		left join t_customer_user_info c
		on a.delivery_id = c.user_uid
		left join t_customer_coupon_sub_info d
		on left(b.lottery_start_id,5) = d.COUPS_Prefix
		left join t_customer_coupon_info e
		on d.COUPS_CPUid = e.COUP_Uid
		left join t_device_device_info h
		on a.device_no = h.DDI_No
		left join study.t_device_sub_info k
		on h.DDI_No = k. DDI_No
		left join netfiance_db.t_shop_shop_info i
		on k.SHOP_No = i.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON i.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join study.t_shop_sub_info j
		on i.SHOP_No = j.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = i.SHOP_Class
		where a.updated_at >= k.DSI_Try and (a.updated_at &lt;= k.DSI_Withdraw or k.DSI_Withdraw is null)
		and k.DSI_Anti is null

		<if test="null != filterMap.ddiNo">
			and h.DDI_No = #{filterMap.ddiNo}
		</if>
		<if test="null != filterMap.shopValue">
			and i.SHOP_No = #{filterMap.shopValue}
		</if>

		and date(a.updated_at) >= #{filterMap.startDate}  and date(a.updated_at) &lt;= #{filterMap.endDate}

		<if test="null != filterMap.channelValue">
			and g.ATOP_Title = #{filterMap.channelValue}
		</if>
		<if test="null != filterMap.deviceTypeValue">
			and h.DDI_Type = #{filterMap.deviceTypeValue}
		</if>
		<if test="null != filterMap.areaValue">
			and j.SHOP_Area = #{filterMap.areaValue}
		</if>
		<if test="null != filterMap.shopTypeValue">
			and t.DICT_Name = #{filterMap.shopTypeValue}
		</if>

		#and i.SHOP_No = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and h.DDI_Type = '{{ 设备类型 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'

		group by a.package_no,e.COUP_Title
		order by a.created_at

	</select>

	<!-- 设备维护统计4 -->
	<select id="sbwhtj4" resultType="java.util.HashMap">
		select c.DDI_No 设备编码,c.SHOP_No 网点编码,DSL_No 机头编号,date(c.DSI_Try) 启用时间,d.COUP_Title 仓内票种,d.COUP_Money 票种金额,a.DSL_Count 实时余量
		from t_device_sub_list a left join t_device_device_info b
		on a.DSL_DUid = b.DDI_Uid
		left join study.t_device_sub_info c
		on b.DDI_No = c.DDI_No
		join t_customer_coupon_info d
		on a.DSL_CPUid = d.COUP_Uid
		left join netfiance_db.t_shop_shop_info i
		on c.SHOP_No= i.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON i.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join study.t_shop_sub_info j
		on i.SHOP_No = j.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = i.SHOP_Class
		where c.DSI_Anti is null
		and a.ModifyDate >= c.DSI_Try and (a.ModifyDate &lt;= c.DSI_Withdraw or c.DSI_Withdraw is null)

		<if test="null != filterMap.ddiNo">
			and b.DDI_No = #{filterMap.ddiNo}
		</if>
		<if test="null != filterMap.shopValue">
			and c.SHOP_No = #{filterMap.shopValue}
		</if>

		<if test="null != filterMap.channelValue">
			and g.ATOP_Title = #{filterMap.channelValue}
		</if>
		<if test="null != filterMap.deviceTypeValue">
			and b.DDI_Type = #{filterMap.deviceTypeValue}
		</if>
		<if test="null != filterMap.areaValue">
			and j.SHOP_Area = #{filterMap.areaValue}
		</if>
		<if test="null != filterMap.shopTypeValue">
			and t.DICT_Name = #{filterMap.shopTypeValue}
		</if>
		
		
		#and c.SHOP_No = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and b.DDI_Type = '{{ 设备类型 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		
		order by 设备编码,DSL_No

	</select>

	<!-- 设备维护统计5 -->
	<select id="sbwhtj5" resultType="java.util.HashMap">
		select device_no as 设备,c.DSL_No 票仓,count(distinct(a.package_no)) as 加仓次数
		from t_storage_checkout_packages a join t_storage_checkout_packages_detail b
		on a.package_no = b.package_no
		left join t_device_sub_list c
		on c.DSL_Uid = b.warehouse_id
		left join t_device_device_info h
		on a.device_no = h.DDI_No
		left join netfiance_db.t_shop_shop_info i
		on h.DDI_SPUid = i.SHOP_Uid
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON i.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join study.t_shop_sub_info j
		on i.SHOP_No = j.SHOP_No
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) t
		on t.DICT_Value = i.SHOP_Class
		where 1 = 1

		<if test="null != filterMap.ddiNo">
			and h.DDI_No = #{filterMap.ddiNo}
		</if>
		<if test="null != filterMap.shopValue">
			and i.SHOP_No = #{filterMap.shopValue}
		</if>

		and date(a.updated_at) >= #{filterMap.startDate}  and date(a.updated_at) &lt;= #{filterMap.endDate}

		<if test="null != filterMap.channelValue">
			and g.ATOP_Title = #{filterMap.channelValue}
		</if>
		<if test="null != filterMap.deviceTypeValue">
			and h.DDI_Type = #{filterMap.deviceTypeValue}
		</if>
		<if test="null != filterMap.areaValue">
			and j.SHOP_Area = #{filterMap.areaValue}
		</if>
		<if test="null != filterMap.shopTypeValue">
			and t.DICT_Name = #{filterMap.shopTypeValue}
		</if>
		
		#and i.SHOP_No = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and h.DDI_Type = '{{ 设备类型 }}'
		#and t.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		group by device_no,c.DSL_No

	</select>

	<!-- 设备交易信息-销售 -->
	<select id="sbjyxx_xs" resultType="java.util.HashMap" >
		select c.DDI_No 设备编号,c.SHOP_No 网点编号,date(c.DSI_Try) 启用时间,sum(b.ODDT_Money*b.ODDT_Count) 累计销售额（元）,sum(b.ODDT_Count) 累计销售票数（张）,count(distinct(a.ODER_Uid)) 累计订单数（单）
		from t_shop_order_info a left join t_shop_order_detail b
		on a.ODER_Uid = b.ODDT_ODUid
		left join t_device_device_info h
		on a.ODER_DUid = h.DDI_Uid
		left join study.t_device_sub_info c
		on c.DDI_No = h.DDI_No
		left join netfiance_db.t_shop_shop_info i
		on c.SHOP_No = i.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON i.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) p
		on p.DICT_Value = i.SHOP_Class
		left join study.t_shop_sub_info j
		on i.SHOP_No = j.SHOP_No
		where c.DSI_Anti is null
		and a.ODER_State = 0
		and a.CreateDate >= c.DSI_Try and (a.CreateDate &lt;= c.DSI_Withdraw or c.DSI_Withdraw is null)

		<if test="null != filterMap.ddiNo">
			and c.DDI_No = #{filterMap.ddiNo}
		</if>
		<if test="null != filterMap.shopValue">
			and c.SHOP_No = #{filterMap.shopValue}
		</if>

		and date(a.CreateDate) >= #{filterMap.startDate}  and date(a.CreateDate) &lt;= #{filterMap.endDate}

		<if test="null != filterMap.channelValue">
			and g.ATOP_Title = #{filterMap.channelValue}
		</if>
		<if test="null != filterMap.deviceTypeValue">
			and h.DDI_Type = #{filterMap.deviceTypeValue}
		</if>
		<if test="null != filterMap.areaValue">
			and j.SHOP_Area = #{filterMap.areaValue}
		</if>
		<if test="null != filterMap.shopTypeValue">
			and p.DICT_Name = #{filterMap.shopTypeValue}
		</if>
		
		#and c.SHOP_No  = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and h.DDI_Type = '{{ 设备类型 }}'
		#and p.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		group by 设备编号,网点编号,启用时间;

	</select>

	<!-- 设备交易信息-退款 -->
	<select id="sbjyxx_tk" resultType="java.util.HashMap" >
		select e.DDI_No 设备编号,e.SHOP_No 网点编号,date(e.DSI_Try) 启动时间,count(distinct(c.ODER_Uid)) 累计退款订单数,sum(a.FLRF_RefundMoney) 累计退款额,count(distinct(c.ODER_USUid)) 累计退款人数
		from netfiance_db.t_finance_bank_refund a left join netfiance_db.t_finance_bank_flow b
		on a.FLRF_FLUid = b.FLOW_Uid
		left join t_shop_order_info c
		on b.FLOW_OrderId = c.ODER_Note
		left join t_device_device_info d
		on c.ODER_DUid = d.DDI_Uid
		left join study.t_device_sub_info e
		on d.DDI_No = e.DDI_No
		left join netfiance_db.t_shop_shop_info i
		on e.SHOP_No = i.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON i.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) p
		on p.DICT_Value = i.SHOP_Class
		left join study.t_shop_sub_info j
		on i.SHOP_No = j.SHOP_No
		where c.ODER_State = 0
		and e.DSI_Anti is null
		and a.CreateDate >= e.DSI_Try and (a.CreateDate &lt;= e.DSI_Withdraw or e.DSI_Withdraw is null)

		<if test="null != filterMap.ddiNo">
			and d.DDI_No = #{filterMap.ddiNo}
		</if>
		<if test="null != filterMap.shopValue">
			and i.SHOP_No = #{filterMap.shopValue}
		</if>

		and date(a.CreateDate) >= #{filterMap.startDate}  and date(a.CreateDate) &lt;= #{filterMap.endDate}

		<if test="null != filterMap.channelValue">
			and g.ATOP_Title = #{filterMap.channelValue}
		</if>
		<if test="null != filterMap.deviceTypeValue">
			and h.DDI_Type = #{filterMap.deviceTypeValue}
		</if>
		<if test="null != filterMap.areaValue">
			and j.SHOP_Area = #{filterMap.areaValue}
		</if>
		<if test="null != filterMap.shopTypeValue">
			and p.DICT_Name = #{filterMap.shopTypeValue}
		</if>
		
		#and i.SHOP_No  = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and h.DDI_Type = '{{ 设备类型 }}'
		#and p.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		group by 设备编号,网点编号,启动时间

	</select>

	<!-- 设备交易信息-退款订单比率 -->
	<select id="sbjyxx_tkddbl" resultType="java.util.HashMap" >
		select d.DDI_No 设备编号,d.SHOP_No 网点编号,date(d.DSI_Try) 启用时间,count(distinct(c.FLRF_Uid))/count(distinct(a.ODER_Uid)) 退款订单比率
		from t_shop_order_info a left join netfiance_db.t_finance_bank_flow b
		on a.ODER_Note = b.FLOW_OrderId
		left join netfiance_db.t_finance_bank_refund c
		on b.FLOW_Uid = c.FLRF_FLUid
		left join t_device_device_info h
		on a.ODER_DUid = h.DDI_Uid
		left join study.t_device_sub_info d
		on h.DDI_No = d.DDI_No
		left join netfiance_db.t_shop_shop_info i
		on d.SHOP_No = i.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON i.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) p
		on p.DICT_Value = i.SHOP_Class
		left join study.t_shop_sub_info j
		on i.SHOP_No = j.SHOP_No
		where d.DSI_Anti is null
		and a.ODER_State = 0
		and a.CreateDate >= d.DSI_Try and (a.CreateDate &lt;= d.DSI_Withdraw or d.DSI_Withdraw is null)

		<if test="null != filterMap.ddiNo">
			and d.DDI_No = #{filterMap.ddiNo}
		</if>
		<if test="null != filterMap.shopValue">
			and d.SHOP_No = #{filterMap.shopValue}
		</if>

		and date(a.CreateDate) >= #{filterMap.startDate}  and date(a.CreateDate) &lt;= #{filterMap.endDate}

		<if test="null != filterMap.channelValue">
			and g.ATOP_Title = #{filterMap.channelValue}
		</if>
		<if test="null != filterMap.deviceTypeValue">
			and h.DDI_Type = #{filterMap.deviceTypeValue}
		</if>
		<if test="null != filterMap.areaValue">
			and j.SHOP_Area = #{filterMap.areaValue}
		</if>
		<if test="null != filterMap.shopTypeValue">
			and p.DICT_Name = #{filterMap.shopTypeValue}
		</if>
		
		#and d.SHOP_No  = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and h.DDI_Type = '{{ 设备类型 }}'
		#and p.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		group by 设备编号,网点编号,启用时间

	</select>

	<!-- 设备交易信息-当日销售 -->
	<select id="sbjyxx_drxs" resultType="java.util.HashMap" >
		select c.DDI_No 设备编号,c.SHOP_No 网点编号,date(c.DSI_Try) 启用时间,sum(b.ODDT_Money*b.ODDT_Count) 当日销售额（元）,sum(b.ODDT_Count) 当日销售票数（张）,count(distinct(a.ODER_Uid)) 当日订单数（单）,max(a.ODER_Money) 当日最大订单额度
		from t_shop_order_info a left join t_shop_order_detail b
		on a.ODER_Uid = b.ODDT_ODUid
		left join t_device_device_info h
		on a.ODER_DUid = h.DDI_Uid
		left join study.t_device_sub_info c
		on c.DDI_No = h.DDI_No
		left join netfiance_db.t_shop_shop_info i
		on c.SHOP_No = i.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON i.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) p
		on p.DICT_Value = i.SHOP_Class
		left join study.t_shop_sub_info j
		on i.SHOP_No = j.SHOP_No
		where c.DSI_Anti is null
		and a.ODER_State = 0
		and a.CreateDate >= c.DSI_Try and (a.CreateDate &lt;= c.DSI_Withdraw or c.DSI_Withdraw is null)
		and date(a.CreateDate) = curdate()

		<if test="null != filterMap.ddiNo">
			and c.DDI_No = #{filterMap.ddiNo}
		</if>
		<if test="null != filterMap.shopValue">
			and c.SHOP_No = #{filterMap.shopValue}
		</if>
		<if test="null != filterMap.channelValue">
			and g.ATOP_Title = #{filterMap.channelValue}
		</if>
		<if test="null != filterMap.deviceTypeValue">
			and h.DDI_Type = #{filterMap.deviceTypeValue}
		</if>
		<if test="null != filterMap.areaValue">
			and j.SHOP_Area = #{filterMap.areaValue}
		</if>
		<if test="null != filterMap.shopTypeValue">
			and p.DICT_Name = #{filterMap.shopTypeValue}
		</if>
		
		#and c.SHOP_No  = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and h.DDI_Type = '{{ 设备类型 }}'
		#and p.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		group by 设备编号,网点编号,启用时间;

	</select>

	<!-- 设备交易信息-当日退款 -->
	<select id="sbjyxx_drtk" resultType="java.util.HashMap" >
		select e.DDI_No 设备编号,e.SHOP_No 网点编号,date(e.DSI_Try) 启动时间,count(distinct(c.ODER_Uid)) 当日退款订单数,sum(a.FLRF_RefundMoney) 当日退款额,count(distinct(c.ODER_USUid)) 当日退款人数
		from netfiance_db.t_finance_bank_refund a left join netfiance_db.t_finance_bank_flow b
		on a.FLRF_FLUid = b.FLOW_Uid
		left join t_shop_order_info c
		on b.FLOW_OrderId = c.ODER_Note
		left join t_device_device_info d
		on c.ODER_DUid = d.DDI_Uid
		left join study.t_device_sub_info e
		on d.DDI_No = e.DDI_No
		left join netfiance_db.t_shop_shop_info i
		on e.SHOP_No = i.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON i.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) p
		on p.DICT_Value = i.SHOP_Class
		left join study.t_shop_sub_info j
		on i.SHOP_No = j.SHOP_No
		where c.ODER_State = 0
		and e.DSI_Anti is null
		and a.CreateDate >= e.DSI_Try and (a.CreateDate &lt;= e.DSI_Withdraw or e.DSI_Withdraw is null)
		and date(a.CreateDate) = curdate()

		<if test="null != filterMap.ddiNo">
			and d.DDI_No = #{filterMap.ddiNo}
		</if>
		<if test="null != filterMap.shopValue">
			and i.SHOP_No = #{filterMap.shopValue}
		</if>
		<if test="null != filterMap.channelValue">
			and g.ATOP_Title = #{filterMap.channelValue}
		</if>
		<if test="null != filterMap.deviceTypeValue">
			and h.DDI_Type = #{filterMap.deviceTypeValue}
		</if>
		<if test="null != filterMap.areaValue">
			and j.SHOP_Area = #{filterMap.areaValue}
		</if>
		<if test="null != filterMap.shopTypeValue">
			and p.DICT_Name = #{filterMap.shopTypeValue}
		</if>
		
		#and i.SHOP_No  = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and h.DDI_Type = '{{ 设备类型 }}'
		#and p.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		group by 设备编号,网点编号,启动时间

	</select>

	<!-- 设备交易信息-当日票种销量 -->
	<select id="sbjyxx_drpzxl" resultType="java.util.HashMap" >
		select b.DDI_No 设备编号,b.SHOP_No 网点编号,date(b.DSI_Try) 启用时间,o.COUP_Title as 票种名称,o.COUP_Money 票种单价,sum(m.ODDT_Count)  累计销售张数,sum(o.COUP_Money*m.ODDT_Count) 累计销售金额
		from t_shop_order_detail m join t_shop_order_info n
		on n.ODER_Uid = m.ODDT_ODUid
		join t_customer_coupon_info o
		on m.ODDT_LTUid=o.COUP_Uid
		left join t_device_device_info a
		on n.ODER_DUid = a.DDI_Uid
		left join study.t_device_sub_info b
		on a.DDI_No = b.DDI_No
		left join netfiance_db.t_shop_shop_info e
		on b.SHOP_No = e.SHOP_No
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON e.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		left join (select DICT_Value,DICT_Name from netfiance_db.t_sys_dictionary_info where DICT_Field = 'shop_class' ) p
		on p.DICT_Value = e.SHOP_Class
		left join study.t_shop_sub_info j
		on e.SHOP_No = j.SHOP_No
		where date(n.CreateDate) = curdate()   #默认为当日
		and ODER_State = 0
		and b.DSI_Anti is null
		and n.CreateDate >= b.DSI_Try and (n.CreateDate &lt;= b.DSI_Withdraw or b.DSI_Withdraw is null)

		<if test="null != filterMap.shopValue">
			and e.SHOP_No = #{filterMap.shopValue}
		</if>
		<if test="null != filterMap.ddiNo">
			and a.DDI_No = #{filterMap.ddiNo}
		</if>
		<if test="null != filterMap.channelValue">
			and g.ATOP_Title = #{filterMap.channelValue}
		</if>
		<if test="null != filterMap.deviceTypeValue">
			and a.DDI_Type = #{filterMap.deviceTypeValue}
		</if>
		<if test="null != filterMap.areaValue">
			and j.SHOP_Area = #{filterMap.areaValue}
		</if>
		<if test="null != filterMap.shopTypeValue">
			and p.DICT_Name = #{filterMap.shopTypeValue}
		</if>
		
		#and e.SHOP_No = '{{门店编码}}'
		#and g.ATOP_Title = '{{ 渠道名称 }}'
		#and a.DDI_Type = '{{ 设备类型 }}'
		#and p.DICT_Name = '{{ 网点类型 }}'
		#and j.SHOP_Area = '{{ 所属地区 }}'
		group by 设备编号,网点编号,启用时间,票种名称

	</select>

	<select id="jqsxxx_transfer_list" resultType="java.util.HashMap">
		select a.ODER_Uid,c.SHOP_Title 网点名称,d.DDI_No 设备编号,a.ODER_Money 订单金额,DATE_FORMAT(a.CreateDate, '%Y-%m-%d %k:%i:%s') 订单时间,a.ODER_CoupMoney 代金券金额,a.ODER_Coup 代金券码
		from t_shop_order_info a
		join netfiance_db.t_shop_shop_info c
		on a.ODER_SPUid = c.SHOP_Uid
		left join t_device_device_info d
		on a.ODER_DUid = d.DDI_Uid
		where date(a.CreateDate) >= #{filterMap.startDate} and date(a.CreateDate) &lt;= #{filterMap.endDate}
		and a.ODER_State = 0
		and d.DDI_No = #{filterMap.ddiNo}
		and c.SHOP_No = #{filterMap.shopValue}
	</select>

	<select id="jqsxxx_transfer_minmax" resultType="java.util.HashMap">
		select Min(a.ODER_Money) min, MAX(a.ODER_Money) max
		from t_shop_order_info a
		join netfiance_db.t_shop_shop_info c
		on a.ODER_SPUid = c.SHOP_Uid
		left join t_device_device_info d
		on a.ODER_DUid = d.DDI_Uid
		where date(a.CreateDate) >= #{filterMap.startDate} and date(a.CreateDate) &lt;= #{filterMap.endDate}
		and a.ODER_State = 0
		and d.DDI_No = #{filterMap.ddiNo}
		and c.SHOP_No = #{filterMap.shopValue}
	</select>

	<select id="wdjyxx" resultType="java.util.HashMap">
		select  o.DDI_No,o.SHOP_No,o.SHOP_Title,o.SHOP_Position,date_format(激活时间,'%Y%m%d') 激活时间,ifnull(date_format(停止时间,'%Y%m%d'),'--') 停止时间,ifnull(i.MTT_money,0) 交易金额总计,ifnull(i.MTT_count,0) 交易张数总计
		from
		(select a.DDI_No,a.SHOP_No,k.SHOP_Position,b.SHOP_Title,date_format(DSI_Try,'%Y%m%d') 激活时间,date_format(DSI_WithDraw,'%Y%m%d') 停止时间
		from study.t_device_sub_info a left join netfiance_db.t_shop_shop_info b
		on b.SHOP_No = a.SHOP_No
		left join t_shop_shop_info k
		on b.SHOP_Uid = k.SHOP_Uid
		where date(a.DSI_Try) &lt;= #{filterMap.endDate}
		and (date(a.DSI_Withdraw) >= #{filterMap.startDate} or a.DSI_Withdraw is null)
		and a.DSI_Anti is null )o    #查询时段内全部运营设备

		left join

		(select i.SHOP_No,h.DDI_No,sum(b.ODDT_Money*b.ODDT_Count) as MTT_money,sum(b.ODDT_Count) MTT_count
		from t_shop_order_info a left join t_shop_order_detail b
		on a.ODER_Uid = b.ODDT_ODUid
		left join t_device_device_info h
		on a.ODER_DUid = h.DDI_Uid
		left join study.t_device_sub_info d
		on h.DDI_No = d.DDI_No
		left join netfiance_db.t_shop_shop_info i
		on a.ODER_SPUid = i.SHOP_Uid
		LEFT JOIN netfiance_db.t_shop_agent_list f
		ON i.SHOP_AGUid = f.AGNT_Uid
		LEFT JOIN netfiance_db.t_shop_agent_top g
		ON f.AGNT_ATUid = g.ATOP_Uid
		where a.ODER_State = 0
		and a.CreateDate >= d.DSI_Try and (a.CreateDate &lt;= d.DSI_Withdraw or d.DSI_Withdraw is null)
		and d.DSI_Anti is null
		and date(a.CreateDate) >= #{filterMap.startDate} and date(a.CreateDate) &lt;= #{filterMap.endDate}
		group by SHOP_No,DDI_No ) i

		on o.DDI_No = i.DDI_No and o.SHOP_No = i.SHOP_No;

	</select>

	
</mapper>
